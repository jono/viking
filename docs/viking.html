<!DOCTYPE html>

<html>
<head>
  <title>viking.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>viking.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Viking.js 0.1.0

(c) 2012-2013 Jonathan Bracy, 42Floors Inc.
Viking.js may be freely distributed under the MIT license.
http://vikingjs.com</code></pre>
<h2>Initial Setup</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Setup the Viking namespace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Viking = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>CSRF Support for Ajax Request</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Set a callback for all AJAX request to set the CSRF Token header
if the meta tag is present.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>jQuery(document).ajaxSend(<span class="keyword">function</span>(event, xhr, settings) {
    <span class="keyword">var</span> token = jQuery(<span class="string">'meta[name="csrf-token"]'</span>).attr(<span class="string">'content'</span>);
    <span class="keyword">if</span> (token) { xhr.setRequestHeader(<span class="string">'X-CSRF-Token'</span>, token); }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2>Viking.Support</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Viking.Support is a collection of utility classes and standard library
extensions that were found useful for the Viking framework. These
additions reside in this package so they can be loaded as needed
in Javascript projects outside of Rails.
strftime relies on <a href="https://github.com/samsonjs/strftime">https://github.com/samsonjs/strftime</a>. It supports
standard specifiers from C as well as some other extensions from Ruby.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Date.prototype.strftime = <span class="keyword">function</span>(fmt) {
    <span class="keyword">return</span> strftime(fmt, <span class="keyword">this</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Since IE8 does not support new Dates with the ISO 8601 format we&#39;ll add
supoprt for it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="keyword">function</span>(){
    <span class="keyword">var</span> d = <span class="keyword">new</span> Date(<span class="string">'2011-06-02T09:34:29+02:00'</span>);
    <span class="keyword">if</span>(!d || +d !== <span class="number">1307000069000</span>) {
        Date.fromISO = <span class="keyword">function</span>(s) {
            <span class="keyword">var</span> i, day, tz, regex, match;
            
            regex = <span class="regexp">/^(\d{4}\-\d\d\-\d\d([tT ][\d:\.]*)?)([zZ]|([+\-])(\d\d):(\d\d))?$/</span>;
            match = regex.exec(s) || [];
            
            <span class="keyword">if</span>(match[<span class="number">1</span>]){
                day = match[<span class="number">1</span>].split(<span class="regexp">/\D/</span>);
                <span class="keyword">for</span>( i= <span class="number">0</span>; i &lt; day.length; i++) {
                    day[i] = parseInt(day[i], <span class="number">10</span>) || <span class="number">0</span>;
                }
                day[<span class="number">1</span>] -= <span class="number">1</span>;
                day = <span class="keyword">new</span> Date(Date.UTC.apply(Date, day));
                <span class="keyword">if</span>(!day.getDate()) { <span class="keyword">return</span> <span class="literal">NaN</span>; }
                <span class="keyword">if</span>(match[<span class="number">5</span>]){
                    tz = (parseInt(match[<span class="number">5</span>], <span class="number">10</span>)*<span class="number">60</span>);
                    <span class="keyword">if</span>(match[<span class="number">6</span>]) { tz += parseInt(match[<span class="number">6</span>], <span class="number">10</span>); }
                    <span class="keyword">if</span>(match[<span class="number">4</span>] === <span class="string">'+'</span>) { tz*= -<span class="number">1</span>; }
                    <span class="keyword">if</span>(tz) { day.setUTCMinutes(day.getUTCMinutes()+ tz); }
                }
                <span class="keyword">return</span> day;
            }

            <span class="keyword">return</span> <span class="literal">NaN</span>;
        };
    } <span class="keyword">else</span> {
        Date.fromISO = <span class="keyword">function</span>(s){
            <span class="keyword">return</span> <span class="keyword">new</span> Date(s);
        };
    }
}());</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>ordinalize returns the ordinal string corresponding to integer:</p>
<pre><code>(1).ordinalize()    // =&gt; &#39;1st&#39;
(2).ordinalize()    // =&gt; &#39;2nd&#39;
(53).ordinalize()   // =&gt; &#39;53rd&#39;
(2009).ordinalize() // =&gt; &#39;2009th&#39;
(-134).ordinalize() // =&gt; &#39;-134th&#39;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>Number.prototype.ordinalize = <span class="keyword">function</span>() {
    <span class="keyword">var</span> abs = Math.abs(<span class="keyword">this</span>);
    
    <span class="keyword">if</span> (abs % <span class="number">100</span> &gt;= <span class="number">11</span> &amp;&amp; abs % <span class="number">100</span> &lt;= <span class="number">13</span>) {
        <span class="keyword">return</span> <span class="keyword">this</span> + <span class="string">'th'</span>;
    }
    
    abs = abs % <span class="number">10</span>;
    <span class="keyword">if</span> (abs === <span class="number">1</span>) { <span class="keyword">return</span> <span class="keyword">this</span> + <span class="string">'st'</span>; }
    <span class="keyword">if</span> (abs === <span class="number">2</span>) { <span class="keyword">return</span> <span class="keyword">this</span> + <span class="string">'nd'</span>; }
    <span class="keyword">if</span> (abs === <span class="number">3</span>) { <span class="keyword">return</span> <span class="keyword">this</span> + <span class="string">'rd'</span>; }
    
    <span class="keyword">return</span> <span class="keyword">this</span> + <span class="string">'th'</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Converts the first character to uppercase</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.capitalize = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.charAt(<span class="number">0</span>).toUpperCase() + <span class="keyword">this</span>.slice(<span class="number">1</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Converts the first character to lowercase</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.anticapitalize = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.charAt(<span class="number">0</span>).toLowerCase() + <span class="keyword">this</span>.slice(<span class="number">1</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Capitalizes all the words and replaces some characters in the string to
create a nicer looking title. titleize is meant for creating pretty output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.titleize = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.underscore().humanize().replace(<span class="regexp">/\b('?[a-z])/g</span>, <span class="keyword">function</span>(m){ <span class="keyword">return</span> m.toUpperCase(); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Capitalizes the first word and turns underscores into spaces and strips a
trailing "_id", if any. Like titleize, this is meant for creating pretty output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.humanize = <span class="keyword">function</span>() {
    <span class="keyword">var</span> result = <span class="keyword">this</span>.toLowerCase().replace(<span class="regexp">/_id$/</span>, <span class="string">''</span>).replace(<span class="regexp">/_/g</span>, <span class="string">' '</span>);
    result = result.replace(<span class="regexp">/([a-z\d]*)/g</span>, <span class="keyword">function</span>(m) { <span class="keyword">return</span> m.toLowerCase(); });
    <span class="keyword">return</span> result.capitalize();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Makes an underscored, lowercase form from the expression in the string.</p>
<p>Changes '::' to '/' to convert namespaces to paths.</p>
<p>Examples:</p>
<pre><code>&quot;ActiveModel&quot;.underscore         # =&gt; &quot;active_model&quot;
&quot;ActiveModel::Errors&quot;.underscore # =&gt; &quot;active_model/errors&quot;</code></pre>
<p>As a rule of thumb you can think of underscore as the inverse of camelize,
though there are cases where that does not hold:</p>
<pre><code>&quot;SSLError&quot;.underscore().camelize() # =&gt; &quot;SslError&quot;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.underscore = <span class="keyword">function</span>() {
    <span class="keyword">var</span> result = <span class="keyword">this</span>.replace(<span class="string">'::'</span>, <span class="string">'/'</span>);
    result = result.replace(<span class="regexp">/([A-Z\d]+)([A-Z][a-z])/g</span>, <span class="string">"$1_$2"</span>);
    result = result.replace(<span class="regexp">/([a-z\d])([A-Z])/g</span>, <span class="string">"$1_$2"</span>);
    <span class="keyword">return</span> result.replace(<span class="string">'-'</span>,<span class="string">'_'</span>).toLowerCase();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>By default, #camelize converts strings to UpperCamelCase. If the argument
to camelize is set to <code>false</code> then #camelize produces lowerCamelCase.</p>
<p>#camelize will also convert &quot;/&quot; to &quot;::&quot; which is useful for converting
paths to namespaces.</p>
<p>Examples:</p>
<pre><code>&quot;active_model&quot;.camelize               // =&gt; &quot;ActiveModel&quot;
&quot;active_model&quot;.camelize(true)         // =&gt; &quot;ActiveModel&quot;
&quot;active_model&quot;.camelize(false)        // =&gt; &quot;activeModel&quot;
&quot;active_model/errors&quot;.camelize        // =&gt; &quot;ActiveModel::Errors&quot;
&quot;active_model/errors&quot;.camelize(false) // =&gt; &quot;activeModel::Errors&quot;</code></pre>
<p>As a rule of thumb you can think of camelize as the inverse of underscore,
though there are cases where that does not hold:</p>
<pre><code>&quot;SSLError&quot;.underscore().camelize()   // =&gt; &quot;SslError&quot;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.camelize = <span class="keyword">function</span>(uppercase_first_letter) {
    <span class="keyword">var</span> result = uppercase_first_letter === <span class="literal">undefined</span> || uppercase_first_letter ? <span class="keyword">this</span>.capitalize() : <span class="keyword">this</span>.anticapitalize();
    result = result.replace(<span class="regexp">/(_|(\/))([a-z\d]*)/g</span>, <span class="keyword">function</span>(_a, _b, first, rest) { <span class="keyword">return</span> (first || <span class="string">''</span>) + rest.capitalize(); });
    <span class="keyword">return</span> result.replace(<span class="string">'/'</span>, <span class="string">'::'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Convert a string to a boolean value. If the argument to #booleanize is
passed if the string is not &#39;true&#39; or &#39;false&#39; it will return the argument.</p>
<p>Examples:</p>
<pre><code>&quot;true&quot;.booleanize()       // =&gt; true
&quot;false&quot;.booleanize()      // =&gt; false
&quot;other&quot;.booleanize()      // =&gt; false
&quot;other&quot;.booleanize(true)  // =&gt; true</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.booleanize = <span class="keyword">function</span>(defaultTo) {
    <span class="keyword">if</span>(<span class="keyword">this</span>.toString() === <span class="string">'true'</span>) { <span class="keyword">return</span> <span class="literal">true</span>; }
    <span class="keyword">if</span> (<span class="keyword">this</span>.toString() === <span class="string">'false'</span>) { <span class="keyword">return</span> <span class="literal">false</span>; }
    
    <span class="keyword">return</span> (defaultTo === <span class="literal">undefined</span> ? <span class="literal">false</span> : defaultTo);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Replaces underscores with dashes.</p>
<p>Example:</p>
<pre><code>&quot;puni_puni&quot;  // =&gt; &quot;puni-puni&quot;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.dasherize = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.replace(<span class="string">'_'</span>,<span class="string">'-'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Replaces special characters in a string so that it may be used as part of
a &quot;pretty&quot; URL.</p>
<p>Example:</p>
<pre><code>&quot;Donald E. Knuth&quot;.parameterize() // =&gt; &#39;donald-e-knuth&#39;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.parameterize = <span class="keyword">function</span>(seperator) {
    <span class="keyword">return</span> <span class="keyword">this</span>.toLowerCase().replace(<span class="regexp">/[^a-z0-9\-_]+/g</span>, seperator || <span class="string">'-'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Add Underscore.inflection#pluralize function on the String object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.pluralize = <span class="keyword">function</span>(count, includeNumber) {
    <span class="keyword">return</span> _.pluralize(<span class="keyword">this</span>, count, includeNumber);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Add Underscore.inflection#singularize function on the String object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>String.prototype.singularize = <span class="keyword">function</span>() {
    <span class="keyword">return</span> _.singularize(<span class="keyword">this</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2>Viking.config</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Helper method to configure defatults on an Viking Object.</p>
<p>Example:</p>
<pre><code>Viking.configure(Viking.Cursor, {per_page: 40});
Viking.configure(Viking.Cursor, &#39;per_page&#39;, 5); // per_page is 5 by defatult</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>Viking.config = <span class="function"><span class="keyword">function</span> <span class="params">(obj, key, val)</span> {</span>
    <span class="keyword">var</span> attrs;
    
    <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'object'</span>) {
      attrs = key;
    } <span class="keyword">else</span> {
      (attrs = {})[key] = val;
    }
    
    <span class="keyword">return</span> _.extend(obj.prototype.defaults, attrs);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2>Viking.Model</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Viking.Model is an extension of <a href="http://backbonejs.org/#Model">Backbone.Model</a>.
It adds naming, relationships, data type coerions, selection, and modifies
sync to work with <a href="http://rubyonrails.org/">Ruby on Rails</a> out of the box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Viking.Model = Backbone.Model.extend({
    
    constructor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Initialize the object as a Backbone Model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Backbone.Model.apply(<span class="keyword">this</span>, arguments);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Add a helper reference to get the model name from an model instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.modelName = <span class="keyword">this</span>.constructor.modelName;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Initialize any <code>hasMany</code> relationships to empty collections if
they are not defined yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> rel, i;
        <span class="keyword">if</span> (<span class="keyword">this</span>.hasMany) {
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.hasMany.length; i++) {
                rel = Viking.Model.getRelationshipDetails(<span class="string">'hasMany'</span>, <span class="keyword">this</span>.hasMany[i]);
                <span class="keyword">if</span>(!<span class="keyword">this</span>.attributes[rel.key]) {
                    <span class="keyword">this</span>.attributes[rel.key] = <span class="keyword">new</span> rel.type();
                }
            }
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>TODO: make the select method work as described below</p>
<p>When the model is part of a collection and you want to select a single
or multiple items from a collection. If a model is selected <code>selected</code>
will be set <code>true</code>, otherwise it will be <code>false</code>.</p>
<p>By default any other models in the collection with be unselected. To
prevent other models in the collection from being unselected you can
pass <code>true</code>.</p>
<p>The <code>selected</code> event is fired when the object is selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    select: <span class="keyword">function</span>(multiple) {
        <span class="keyword">this</span>.collection.select(<span class="keyword">this</span>, multiple);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>TODO: implement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    unselect: <span class="keyword">function</span>() {
        
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Alias for <code>::urlRoot</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    urlRoot: <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.constructor.urlRoot();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Returns string to use for params names. This is the key attributes from
the model will be namespaced under when saving to the server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    paramRoot: <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.modelName.underscore();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Returns a string representing the object's key suitable for use in URLs,
or nil if <code>#isNew</code> is true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toParam: <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.isNew() ? <span class="literal">null</span> : <span class="keyword">this</span>.get(<span class="string">'id'</span>);
    },
    
    set: <span class="function"><span class="keyword">function</span> <span class="params">(key, val, options)</span> {</span>
        <span class="keyword">var</span> attrs;
        <span class="keyword">if</span> (key === <span class="literal">null</span>) { <span class="keyword">return</span> <span class="keyword">this</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'object'</span>) {
            attrs = key;
            options = val;
        } <span class="keyword">else</span> {
            (attrs = {})[key] = val;
        }

        <span class="keyword">this</span>.coerceAttributes(attrs);

        <span class="keyword">return</span> Backbone.Model.prototype.set.call(<span class="keyword">this</span>, attrs, options);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Override <a href="http://backbonejs.org/#Model-sync">Backbone.Model#sync</a>.
<a href="http://rubyonrails.org/">Ruby on Rails</a> expects the attributes to be
namespaced</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sync: <span class="keyword">function</span>(method, model, options) {
        options || (options = {});
        
        <span class="keyword">if</span> (!options.data &amp;&amp; (method === <span class="string">'create'</span> || method === <span class="string">'update'</span> || method === <span class="string">'patch'</span>)) {
            options.contentType = <span class="string">'application/json'</span>;
            options.data = {};
            options.data[_.result(model, <span class="string">'paramRoot'</span>)] = (options.attrs || model.toJSON(options));
            options.data = JSON.stringify(options.data);
        }

        <span class="keyword">return</span> Backbone.sync.call(<span class="keyword">this</span>, method, model, options);
    },
    
    coerceAttributes: <span class="keyword">function</span>(attrs) {
        <span class="keyword">var</span> rel, i, type, klass;

        <span class="keyword">if</span> (<span class="keyword">this</span>.belongsTo) {
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.belongsTo.length; i++) {
                rel = Viking.Model.getRelationshipDetails(<span class="string">'belongsTo'</span>, <span class="keyword">this</span>.belongsTo[i]);
                <span class="keyword">if</span> (attrs[rel.key] &amp;&amp; !(attrs[rel.key] <span class="keyword">instanceof</span> rel.type)) {
                    attrs[rel.key] = <span class="keyword">new</span> rel.type(attrs[rel.key]);
                }
            }
        }

        <span class="keyword">if</span> (<span class="keyword">this</span>.hasMany) {
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.hasMany.length; i++) {
                rel = Viking.Model.getRelationshipDetails(<span class="string">'hasMany'</span>, <span class="keyword">this</span>.hasMany[i]);
                <span class="keyword">if</span> (attrs[rel.key] &amp;&amp; !(attrs[rel.key] <span class="keyword">instanceof</span> rel.type)) {
                    attrs[rel.key] = <span class="keyword">new</span> rel.type(attrs[rel.key]);
                }
            }
        }

        _.each(<span class="keyword">this</span>.coercions, <span class="function"><span class="keyword">function</span> <span class="params">(type, key)</span> {</span>
            <span class="keyword">if</span> (attrs[key]) {
                klass = window[type];
                <span class="keyword">if</span> (klass === Date) {
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> attrs[key] === <span class="string">'string'</span> || <span class="keyword">typeof</span> attrs[key] === <span class="string">'number'</span>) {
                        attrs[key] = Date.fromISO(attrs[key]);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (!(attrs[key] <span class="keyword">instanceof</span> Date)) {
                        <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="keyword">typeof</span> attrs[key] + <span class="string">" can't be coerced into "</span> + type);
                    }
                } <span class="keyword">else</span> {
                    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">"Coercion of "</span> + type + <span class="string">" unsupported"</span>);
                }
            }
        });

        <span class="keyword">return</span> attrs;
    },
    
    toJSON: <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
        <span class="keyword">var</span> rel, i;
        <span class="keyword">var</span> data = _.clone(<span class="keyword">this</span>.attributes);

        <span class="keyword">if</span> (<span class="keyword">this</span>.belongsTo) {
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.belongsTo.length; i++) {
                rel = Viking.Model.getRelationshipDetails(<span class="string">'belongsTo'</span>, <span class="keyword">this</span>.belongsTo[i]);

                <span class="keyword">if</span> (data[rel.key]) {
                    data[rel.key+<span class="string">'_attributes'</span>] = data[rel.key].toJSON();
                    <span class="keyword">delete</span> data[rel.key];
                } <span class="keyword">else</span> <span class="keyword">if</span> (data[rel.key] === <span class="literal">null</span>) {
                    data[rel.key+<span class="string">'_attributes'</span>] = <span class="literal">null</span>;
                    <span class="keyword">delete</span> data[rel.key];
                }
            }
        }

        <span class="keyword">if</span> (<span class="keyword">this</span>.hasMany) {
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.hasMany.length; i++) {
                rel = Viking.Model.getRelationshipDetails(<span class="string">'hasMany'</span>, <span class="keyword">this</span>.hasMany[i]);

                <span class="keyword">if</span> (data[rel.key]) {
                    data[rel.key + <span class="string">'_attributes'</span>] = data[rel.key].toJSON();
                    <span class="keyword">delete</span> data[rel.key];
                }
            }
        }

        _.each(<span class="keyword">this</span>.coercions, <span class="function"><span class="keyword">function</span> <span class="params">(type, key)</span> {</span>
            <span class="keyword">if</span> (data[key]) {
                <span class="keyword">if</span> (type === <span class="string">'Date'</span>) {
                    data[key] = data[key].toISOString();
                } <span class="keyword">else</span> {
                    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">"Coercion of "</span> + type + <span class="string">" unsupported"</span>);
                }
            }
        });

        <span class="keyword">return</span> data;
    }
    
}, {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>TODO: test support not passing in name and just protoProps &amp; staticProps
Overide the default extend method to support passing in the model name
to be used for url generation and replationships.</p>
<p><code>name</code> is optional, and must be a string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    extend: <span class="keyword">function</span>(name, protoProps, staticProps) {
        <span class="keyword">if</span>(<span class="keyword">typeof</span> name !== <span class="string">'string'</span>) {
            staticProps = protoProps;
            protoProps = name;
        }
        <span class="keyword">var</span> child = Backbone.Model.extend.call(<span class="keyword">this</span>, protoProps, staticProps);
        <span class="keyword">if</span>(<span class="keyword">typeof</span> name === <span class="string">'string'</span>) { child.modelName = name; }
        <span class="keyword">return</span> child;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Generates the <code>urlRoot</code> based off of the model name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    urlRoot: <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="string">"/"</span> + <span class="keyword">this</span>.modelName.pluralize();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    find: <span class="keyword">function</span>(id, options) {
        Backbone.sync(<span class="string">'GET'</span>, <span class="keyword">new</span> <span class="keyword">this</span>({id: id}), options);
    },
    
    getRelationshipDetails: <span class="function"><span class="keyword">function</span> <span class="params">(type, key, options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Handle both <code>type, key, options</code> and <code>type, [key, options]</code> style arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (_.isArray(key)) {
            options = key[<span class="number">1</span>];
            key = key[<span class="number">0</span>];
        }

        <span class="keyword">var</span> relation = {
            key: key
        };

        <span class="keyword">if</span> (options) {
            <span class="keyword">if</span> (type === <span class="string">'hasMany'</span> &amp;&amp; options.collection) {
                relation.type = window[options.collection];
            } <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'hasMany'</span> &amp;&amp; options.model) {
                relation.type = window[options.model + <span class="string">'Collection'</span>];
            } <span class="keyword">else</span> {
                relation.type = window[options.model];
            }
        } <span class="keyword">else</span> {
            <span class="keyword">if</span> (type === <span class="string">'belongsTo'</span>) {
                relation.type = window[relation.key.camelize()];
            } <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'hasMany'</span>) {
                relation.type = window[relation.key.camelize(<span class="literal">true</span>).replace(<span class="regexp">/s$/</span>, <span class="string">''</span>) + <span class="string">'Collection'</span>];
            }
        }

        <span class="keyword">return</span> relation;
    }
    
});</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h2>Viking.Collection</h2>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Viking.Collection is an extension of <a href="http://backbonejs.org/#Collection">Backbone.Collection</a>.
It adds predicates, selection, and modifies fetch to cancel any current
request if a new fetch is triggered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Viking.Collection = Backbone.Collection.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Set the default model to a generic Viking.Model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    model: Viking.Model,

    constructor: <span class="keyword">function</span>(models, options) {
        Backbone.Collection.apply(<span class="keyword">this</span>, arguments);
        
        <span class="keyword">if</span>(options &amp;&amp; options.predicate) {
            <span class="keyword">this</span>.setPredicate(options.predicate, {silent: <span class="literal">true</span>});
        }
    },
    
    url: <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="string">"/"</span> + <span class="keyword">this</span>.model.modelName.underscore().pluralize();
    },
    paramRoot: <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.model.modelName.underscore().pluralize();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>If a predicate is set it&#39;s paramaters will be passed under the
<code>where</code> key when querying the server. #predicateChanged is
set as a callback on the <code>change</code> event for the predicate</p>
<h1>setPredicate accepts either attributes to instaniate a</h1>
<p>Viking.Predicate or an instanceof a Viking.Predicate</p>
<p>To remove a predeicate call <code>#setPredicate</code> with a falsey value.</p>
<p>Calling #setPredicate and setting it the same object that is currently
the predicate will not trigger a #predicateChanged call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setPredicate: <span class="keyword">function</span>(predicate, options) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.predicate === predicate) { <span class="keyword">return</span> <span class="literal">false</span>; }
        
        <span class="keyword">if</span>(<span class="keyword">this</span>.predicate) { <span class="keyword">this</span>.stopListening(<span class="keyword">this</span>.predicate); }
        
        <span class="keyword">if</span>(predicate) {
            <span class="keyword">if</span>(!(predicate <span class="keyword">instanceof</span> Viking.Predicate)) {
                predicate = <span class="keyword">new</span> Viking.Predicate(predicate);
            }
            <span class="keyword">this</span>.predicate = predicate;
            <span class="keyword">this</span>.listenTo(predicate, <span class="string">'change'</span>, <span class="keyword">this</span>.predicateChanged);
            <span class="keyword">if</span>(!(options &amp;&amp; options.silent)) { <span class="keyword">this</span>.predicateChanged(); }
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.predicate) {
            <span class="keyword">delete</span> <span class="keyword">this</span>.predicate;
            <span class="keyword">if</span>(!(options &amp;&amp; options.silent)) { <span class="keyword">this</span>.predicateChanged(); }
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Called when the predicate is changed. Having this being called
when the predicate changes instead of just <code>fetch</code> allows sub
collections to overwrite what happens when it changes. An example
of this would be the <code>Viking.PaginatedCollection</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    predicateChanged: <span class="keyword">function</span>(predicate, options) {
        <span class="keyword">this</span>.fetch();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Sets <code>&#39;selected&#39;</code> to <code>true</code> on the <code>model</code>. If <code>clearCurrentlySelected</code>
is truthy all other models will have <code>selected</code> set to <code>false</code>.
Also triggers the <code>selected</code> event on the collection. If the model is
already selected the <code>selected</code> event is not triggered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    select: <span class="keyword">function</span>(model, clearCurrentlySelected) {
        <span class="keyword">if</span>(!clearCurrentlySelected) {
            <span class="keyword">this</span>.clearSelected(model);
        }
        <span class="keyword">if</span>(!model.get(<span class="string">'selected'</span>)) {
            model.set(<span class="string">'selected'</span>, <span class="literal">true</span>);
            <span class="keyword">this</span>.trigger(<span class="string">'selected'</span>, <span class="keyword">this</span>.selected());
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>returns all the models where <code>selected</code> == true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    selected: <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.filter(<span class="keyword">function</span>(m) { <span class="keyword">return</span> m.get(<span class="string">'selected'</span>); });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Sets <code>&#39;selected&#39;</code> to <code>false</code> on all models</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearSelected: <span class="keyword">function</span>(exceptModel) {
        <span class="keyword">if</span>(exceptModel <span class="keyword">instanceof</span> Viking.Model) {
            exceptModel = exceptModel.cid;
        }
        <span class="keyword">this</span>.each(<span class="keyword">function</span>(m) {
            <span class="keyword">if</span>(m.cid !== exceptModel) {
                m.set(<span class="string">'selected'</span>, <span class="literal">false</span>);
            }
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Override the default Backbone.Collection#fetch to cancel any current
fetch request if fetch is called again. For example when the predicate
changes 3 times, if the first 2 request don&#39;t return before the 3rd is
sent they will be canceled and only the last one will finish and update
the collection. You won&#39;t get the collection being updated 3 times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fetch: <span class="keyword">function</span>(options) {
        options || (options = {});
        
        <span class="keyword">var</span> complete = options.complete;
        options.complete = _.bind(<span class="keyword">function</span>() {
            <span class="keyword">delete</span> <span class="keyword">this</span>.xhr;
            <span class="keyword">if</span>(complete) { complete(); }
        }, <span class="keyword">this</span>);
        
        <span class="keyword">if</span> (<span class="keyword">this</span>.xhr) { <span class="keyword">this</span>.xhr.abort(); }
        <span class="keyword">this</span>.xhr = Backbone.Collection.prototype.fetch.call(<span class="keyword">this</span>, options);
    },
    
    sync: <span class="keyword">function</span>(method, model, options) {
        <span class="keyword">if</span>(method === <span class="string">'read'</span> &amp;&amp; <span class="keyword">this</span>.predicate) {
            options.data || (options.data = {});
            options.data.where = <span class="keyword">this</span>.predicate.attributes;
        }
        <span class="keyword">return</span> Backbone.sync.call(<span class="keyword">this</span>, method, model, options);
    }
    
});
Backbone.Model.prototype.updateAttribute = <span class="function"><span class="keyword">function</span> <span class="params">(key, value, options)</span>{</span>
    <span class="keyword">var</span> data;
    (data = {})[key] = value;
    <span class="keyword">this</span>.updateAttributes(data, options);
};

Backbone.Model.prototype.updateAttributes = <span class="function"><span class="keyword">function</span> <span class="params">(data, options)</span> {</span>
    <span class="keyword">this</span>.save(data, options);
};
Viking.PaginatedCollection = Viking.Collection.extend({
    constructor: <span class="keyword">function</span>(models, options) {
        Viking.Collection.apply(<span class="keyword">this</span>, arguments);
        <span class="keyword">this</span>.cursor = ((options &amp;&amp; options.cursor) || <span class="keyword">new</span> Viking.Cursor());
        <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.cursor, <span class="string">'change'</span>, <span class="keyword">function</span>() {
            <span class="keyword">if</span>(<span class="keyword">this</span>.cursor.requiresRefresh()) {
                <span class="keyword">this</span>.cursorChanged.apply(<span class="keyword">this</span>, arguments);
            }
        });
    },
    
    predicateChanged: <span class="keyword">function</span>(predicate, options) {
        <span class="keyword">this</span>.cursor.reset({silent: <span class="literal">true</span>});
        <span class="keyword">this</span>.cursorChanged();
    },
    
    cursorChanged: <span class="keyword">function</span>(cursor, options) {
        <span class="keyword">this</span>.fetch();
    },
    
    parse: <span class="keyword">function</span>(attrs, xhr) {
        <span class="keyword">var</span> cursor_keys = [<span class="string">'page'</span>, <span class="string">'per_page'</span>, <span class="string">'offset'</span>, <span class="string">'total'</span>, <span class="string">'total_pages'</span>, <span class="string">'count'</span>];
        <span class="keyword">var</span> cursor_attrs = _.pick(attrs, cursor_keys);
        _.each(cursor_attrs, <span class="keyword">function</span>(v, k) {
            cursor_attrs[k] = parseInt(v, <span class="number">10</span>);
        })

        <span class="keyword">this</span>.cursor.set(cursor_attrs);
        <span class="keyword">return</span> attrs[<span class="keyword">this</span>.paramRoot()];
    },
    
    sync: <span class="keyword">function</span>(method, model, options) {
        <span class="keyword">if</span>(method === <span class="string">'read'</span>) {
            options.data || (options.data = {});
            options.data.page = model.cursor.get(<span class="string">'page'</span>);
            options.data.per_page = model.cursor.get(<span class="string">'per_page'</span>);
            options.data.offset = model.cursor.get(<span class="string">'offset'</span>);
        }
        <span class="keyword">return</span> Viking.Collection.prototype.sync.call(<span class="keyword">this</span>, method, model, options);
    }
    
});</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>TODO remove?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Viking.Controller = Backbone.Model.extend({}, {
    
    instance: <span class="keyword">function</span>(onInstantiated, onInstantiation) {
        <span class="keyword">if</span>(<span class="keyword">this</span>._instance) {
            <span class="keyword">if</span>(onInstantiated) { onInstantiated(<span class="keyword">this</span>._instance); }
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>._instance = <span class="keyword">new</span> <span class="keyword">this</span>();
            <span class="keyword">if</span>(onInstantiation) { onInstantiation(<span class="keyword">this</span>._instance); }
        }

        <span class="keyword">return</span> <span class="keyword">this</span>._instance;
    }
});
Viking.Predicate = Backbone.Model;
Viking.Cursor = Backbone.Model.extend({
    defaults: {
        page: <span class="number">1</span>,
        offset: <span class="number">0</span>,
        per_page: <span class="number">25</span>,
        total: <span class="literal">undefined</span>,
        total_pages: <span class="literal">undefined</span>
    },
    
    reset: <span class="keyword">function</span>(options) {
        <span class="keyword">this</span>.set({
            page: <span class="number">1</span>,
            offset: <span class="number">0</span>,
            total: <span class="literal">undefined</span>,
            total_pages: <span class="literal">undefined</span>
        }, {silent: <span class="literal">true</span>});
        <span class="keyword">if</span>(!(options &amp;&amp; options.silent) &amp;&amp; <span class="keyword">this</span>.requiresRefresh()) {
            <span class="keyword">this</span>.trigger(<span class="string">'reset'</span>, <span class="keyword">this</span>, options);
        }
    },
    
    incrementPage: <span class="keyword">function</span>(options) {
        <span class="keyword">this</span>.set(<span class="string">'page'</span>, <span class="keyword">this</span>.get(<span class="string">'page'</span>) + <span class="number">1</span>, options);
    },
    
    decrementPage: <span class="keyword">function</span>(options) {
        <span class="keyword">this</span>.set(<span class="string">'page'</span>, <span class="keyword">this</span>.get(<span class="string">'page'</span>) - <span class="number">1</span>, options);
    },
    
    goToPage: <span class="keyword">function</span>(pageNumber, options) {
        <span class="keyword">this</span>.set(<span class="string">'page'</span>, pageNumber, options);
    },
    
    requiresRefresh: <span class="keyword">function</span>() {
        <span class="keyword">var</span> changedAttributes = <span class="keyword">this</span>.changedAttributes();
        <span class="keyword">if</span>(changedAttributes) {
            <span class="keyword">var</span> triggers = [<span class="string">'page'</span>, <span class="string">'offset'</span>, <span class="string">'per_page'</span>];
            <span class="keyword">return</span> (_.intersection(_.keys(changedAttributes), triggers).length &gt; <span class="number">0</span>);
        }
        
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    
});
Viking.Router = Backbone.Router.extend({
    
    route: <span class="keyword">function</span>(route, name, callback) {
        <span class="keyword">var</span> router, controller, action;
        
        <span class="keyword">if</span> (!_.isRegExp(route)) {
            <span class="keyword">if</span>(<span class="regexp">/^r\/.*\/$/</span>.test(route)) {
                route = <span class="keyword">new</span> RegExp(route.slice(<span class="number">2</span>, -<span class="number">1</span>));
            } <span class="keyword">else</span> {
                route = <span class="keyword">this</span>._routeToRegExp(route);
            }
        }
        <span class="keyword">if</span> (_.isFunction(name)) {
            callback = name;
            name = <span class="string">''</span>;
        }

        <span class="keyword">if</span> (_.isObject(name)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>TODO: maybe this should be Controller::action since it&#39;s not
an instance method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            controller = <span class="regexp">/^(\w+)#(\w+)$/</span>.exec(name.to);
            action = controller[<span class="number">2</span>];
            controller = controller[<span class="number">1</span>];
            name = name.name;
            
            <span class="keyword">if</span> (window[controller] &amp;&amp; window[controller][action]) {
                callback = window[controller][action];
            }
        }
        <span class="keyword">if</span> (!callback) { callback = <span class="keyword">this</span>[name]; }
                
        router = <span class="keyword">this</span>;
        Backbone.history.route(route, <span class="keyword">function</span>(fragment) {
            <span class="keyword">var</span> args = router._extractParameters(route, fragment);
            callback &amp;&amp; callback.apply(router, args);
            router.trigger.apply(router, [<span class="string">'route:'</span> + name].concat(args));
            router.trigger(<span class="string">'route'</span>, name, args);
            Backbone.history.trigger(<span class="string">'route'</span>, router, name, args);
        });
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },
        
    start: <span class="keyword">function</span>() {
        <span class="keyword">return</span> Backbone.history.start({pushState: <span class="literal">true</span>});
    },
    stop: <span class="keyword">function</span>() {
        Backbone.history.stop();
    },
    
    navigate: <span class="keyword">function</span>(fragment, args) {
        <span class="keyword">var</span> root_url = window.location.protocol + <span class="string">'//'</span> + window.location.host;
        <span class="keyword">if</span>(fragment.indexOf(root_url) === <span class="number">0</span>) { fragment = fragment.replace(root_url, <span class="string">''</span>); }
        
        Backbone.Router.prototype.navigate.call(<span class="keyword">this</span>, fragment, args);
    }
    
});</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
